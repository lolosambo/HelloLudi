{% extends 'base.html.twig' %}

{% block title %}{{ post.getTitle() }} - Hello Ludi{% endblock %}

{% block meta_description %}{{ post.getContent()|striptags|slice(0, 160) }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block og_title %}{{ post.getTitle() }}{% endblock %}

{% block og_description %}{{ post.getContent()|striptags|slice(0, 160) }}{% endblock %}

{% block og_image %}
    {% if post.getImage() %}
        {{ app.request.schemeAndHttpHost }}/{{ post.getImage() }}
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/comments.css') }}">
    <link href="{{ asset('css/post-content-styles.css') }}" rel="stylesheet">
    <link href="{{ asset('css/stable-images.css') }}" rel="stylesheet">
    <link href="{{ asset('css/image-fix-v3.css') }}" rel="stylesheet">
    <link href="{{ asset('css/table-editor.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/pages/post-detail.css') }}">
{% endblock %}

{% block content %}
    <div class="post-detail-container-wide fade-in">
        {% for type, messages in app.flashes %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="alert alert-{{ type }}">
                        <i class="bi bi-{{ type == 'success' ? 'check-circle' : 'exclamation-triangle' }} me-2"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

        <!-- Header de l'article - Pleine largeur -->
        <div class="post-header-wide">
            <h1 class="post-title">{{ post.getTitle() }}</h1>
            {% if post.getDate() and post.getPlace() %}
                <div class="post-meta">
                    <div class="meta-item">
                        <i class="bi bi-calendar-event"></i>
                        {{ post.getDate() | date('d/m/Y') }}
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-geo-alt"></i>
                        {{ post.getPlace() }}
                    </div>
                </div>
            {% elseif post.getPersonsNumber() and post.getCookingTime() %}
                <div class="post-meta">
                    <div class="meta-item">
                        <i class="bi bi-people"></i>
                        {{ post.getPersonsNumber() }} personnes
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-clock"></i>
                        {{ post.getCookingTime() }} minutes
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Layout √† 2 colonnes ou colonne unique selon les commentaires -->
        <div class="row g-0 post-layout" id="postLayout">
            <!-- Colonne principale (contenu) -->
            <div class="col-lg-12 main-content-column" id="mainContentColumn">
                <!-- Image d'illustration -->
                {% if post.getImage() %}
                    <div class="post-image-section">
                        <div class="post-image-container">
                            <img src="{{ asset(post.getImage()) }}"
                                 alt="{{ post.getTitle() }}"
                                 class="post-featured-image">
                            <div class="image-overlay">
                                <div class="image-caption">
                                    <i class="bi bi-camera-fill me-2"></i>
                                    Image d'illustration
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Contenu de l'article -->
                <div class="post-content-wrapper">
                    <div class="post-content">
                        {{ post.getContent() | raw }}
                    </div>
                    
                    <!-- Galerie d'images int√©gr√©e pour les posts de type photo -->
                    {% if post.category == 'photo' and post.hasGalleryImages() %}
                        <div class="photo-gallery">
                            {% for postImage in post.postImages %}
                                <div class="gallery-item-display">
                                    <img src="{{ postImage.imageUrl }}" 
                                         alt="{{ postImage.alt ? postImage.alt : 'Image de galerie' }}" 
                                         class="gallery-image"
                                         style="cursor: pointer;"
                                         data-image-src="{{ postImage.imageUrl }}"
                                         data-image-alt="{{ postImage.alt ? postImage.alt : 'Image de galerie' }}">
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Actions et contenu apr√®s galerie -->
                <div class="post-actions-wrapper">
                    <!-- Boutons d'action -->
                    <div class="action-buttons">
                        <a href="{{ path("homepage") }}" class="btn-modern btn-salmon interactive">
                            <i class="bi bi-arrow-left-circle"></i>
                            Retour aux articles
                        </a>

                        {% if comments is not empty %}
                        <button class="btn-modern btn-brown interactive" data-custom-modal="commentModal">
                            <i class="bi bi-chat-dots"></i>
                            Ajouter un commentaire
                        </button>
                        {% else %}
                        <button class="btn-modern btn-brown interactive" data-custom-modal="commentModal">
                            <i class="bi bi-chat-dots"></i>
                            √ätre le premier √† commenter
                        </button>
                        {% endif %}

                        {% if app.user and app.user.getid() not in post.getLikes() %}
                            <a href="{{ path("post_like", { "post": post.getId(), "user": app.user.getId()}) }}" class="btn-modern btn-primary interactive">
                                <i class="bi bi-heart"></i>
                                J'aime cet article
                            </a>
                        {% endif %}
                    </div>
                    
                    <!-- Section de partage sur les r√©seaux sociaux -->
                    {% include 'components/social/share_buttons.html.twig' with {
                        'title': post.getTitle(),
                        'url': app.request.schemeAndHttpHost ~ path('post_detail', {'post': post.getId()}),
                        'description': post.getContent()|striptags|slice(0, 150) ~ '...',
                        'hashtags': post.category == 'recipe' ? 'recette,cuisine,helloludi' : (post.category == 'photo' ? 'photo,voyage,helloludi' : 'helloludi,blog')
                    } %}

                    <!-- Section de notation pour les recettes -->
                    {% if post.category == "recipe" %}
                        <div class="rating-section">
                            <h3>üí´ Notez cette d√©licieuse recette</h3>
                            <div class="star-rating"
                                 data-post-id="{{ post.id }}"
                                 data-user-rated="{{ userRated ? 'true' : 'false' }}">
                                {% for i in 1..5 %}
                                    <i class="fa fa-star {{ i <= (userRating ?: 0) ? 'selected' : '' }}"
                                       data-value="{{ i }}"
                                       {% if userRated %}style="pointer-events: none;"{% endif %}>
                                    </i>
                                {% endfor %}
                            </div>
                            <div class="rating-message">
                                {% if userRated %}
                                    <p><strong>üéâ Merci ! Vous avez donn√© {{ userRating }} √©toile(s)</strong></p>
                                {% endif %}
                                <p><strong>Note moyenne :</strong> {{ post.getAverageRating() }}/5 ‚≠ê</p>
                                <p><strong>Nombre de votes :</strong> {{ post.getRatingCount() }} gourmets</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Colonne des commentaires (sidebar) - Toujours pr√©sente mais r√©tractable -->
            <div class="comments-sidebar" id="commentsSidebar">
                <div class="comments-section-sidebar">
                    <div class="comments-header">
                        <h4><i class="bi bi-chat-square-text me-2"></i>Commentaires</h4>
                        <button class="btn-add-comment" data-custom-modal="commentModal">
                            <i class="bi bi-plus-circle me-1"></i>
                            Ajouter un commentaire
                        </button>
                    </div>

                    <div class="comments-scroll-area">
                        {% if comments is not empty %}
                            {% for comment in comments %}
                                <div class="comment fade-in">
                                    <div class="comment-header">
                                        <div class="comment-avatar">
                                            {{ comment.getPseudo()|upper }}
                                        </div>
                                        <div class="comment-meta">
                                            <div class="comment-author">{{ comment.getPseudo() }}</div>
                                            <div class="comment-date">
                                                <i class="bi bi-clock me-1"></i>
                                                {{ comment.getCreationDate()|date('d/m/Y √† H:i') }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="comment-content">
                                        {{ comment.getContent()|raw }}
                                        <div class="mt-3">
                                            <button class="btn-reply" data-custom-modal="replyModal-{{ comment.id }}">
                                                <i class="bi bi-reply me-1"></i>
                                                R√©pondre
                                            </button>
                                        </div>
                                    </div>

                                    {% if comment.getReplies() is not empty %}
                                        <div class="comment-replies">
                                            {% for reply in comment.getReplies() %}
                                                <div class="reply">
                                                    <div class="reply-header">
                                                        <div class="reply-avatar">
                                                            {{ reply.getPseudo()|upper }}
                                                        </div>
                                                        <div>
                                                            <strong>{{ reply.getPseudo() }}</strong>
                                                            <div class="comment-date">
                                                                <i class="bi bi-clock me-1"></i>
                                                                {{ reply.getCreationDate()|date('d/m/Y √† H:i') }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        {{ reply.getContent()|raw }}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Modale personnalis√©e pour r√©pondre -->
                                <div class="custom-modal" id="replyModal-{{ comment.id }}" style="display: none;">
                                    <div class="custom-modal-backdrop"></div>
                                    <div class="custom-modal-dialog">
                                        <div class="custom-modal-content">
                                            <div class="custom-modal-header">
                                                <h5 class="custom-modal-title">
                                                    <i class="bi bi-reply me-2"></i>
                                                    R√©pondre √† {{ comment.getPseudo() }}
                                                </h5>
                                                <button type="button" class="custom-btn-close" data-custom-close="replyModal-{{ comment.id }}">&times;</button>
                                            </div>
                                            <div class="custom-modal-body">
                                                {{ form_start(replyForms[comment.id], {'attr': {'class': 'reply-form'}}) }}
                                                <div class="form-group-modal">
                                                    {{ form_label(replyForms[comment.id].pseudo) }}
                                                    {{ form_widget(replyForms[comment.id].pseudo, {'attr': {'class': 'form-control'}}) }}
                                                    {{ form_errors(replyForms[comment.id].pseudo) }}
                                                </div>
                                                <div class="form-group-modal">
                                                    {{ form_label(replyForms[comment.id].content) }}
                                                    {{ form_widget(replyForms[comment.id].content, {'attr': {'class': 'form-control', 'rows': '4'}}) }}
                                                    {{ form_errors(replyForms[comment.id].content) }}
                                                </div>
                                                <div class="text-center">
                                                    <input type="hidden" name="comment[parent]" value="{{ comment.id ?? '' }}">
                                                    <button type="submit" class="btn-modern btn-success">
                                                        <i class="bi bi-send"></i>
                                                        Envoyer la r√©ponse
                                                    </button>
                                                </div>
                                                {{ form_end(replyForms[comment.id]) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-comments">
                                <i class="bi bi-chat-dots"></i>
                                <h5>Aucun commentaire pour le moment</h5>
                                <p>Soyez le premier √† partager votre avis !</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Onglet pour ouvrir/fermer la colonne commentaires -->
        <div class="comments-toggle-tab" id="commentsToggleTab">
            <i class="bi bi-chat-dots" id="toggleIcon"></i>
            {% if comments|length > 0 %}
            <span class="comment-count" id="commentCount">{{ comments|length }}</span>
            {% else %}
            <span class="comment-count" id="commentCount" style="display: none;">0</span>
            {% endif %}
        </div>
    </div>

    <!-- Modale personnalis√©e pour commentaire principal -->
    <div class="custom-modal" id="commentModal" style="display: none;">
        <div class="custom-modal-backdrop"></div>
        <div class="custom-modal-dialog">
            <div class="custom-modal-content">
                <div class="custom-modal-header">
                    <h5 class="custom-modal-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        Ajouter un commentaire
                    </h5>
                    <button type="button" class="custom-btn-close" data-custom-close="commentModal">&times;</button>
                </div>
                <div class="custom-modal-body">
                    {{ form_start(form, {'attr': {'class': 'comment-form'}}) }}
                    <div class="form-group-modal">
                        {{ form_label(form.pseudo) }}
                        {{ form_widget(form.pseudo, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.pseudo) }}
                    </div>
                    <div class="form-group-modal">
                        {{ form_label(form.content) }}
                        {{ form_widget(form.content, {'attr': {'class': 'form-control', 'rows': '5'}}) }}
                        {{ form_errors(form.content) }}
                    </div>
                    <div class="text-center">
                        <input type="hidden" name="comment[parent]" value="{{ comment.id ?? '' }}">
                        <button type="submit" class="btn-modern btn-success">
                            <i class="bi bi-send"></i>
                            Publier le commentaire
                        </button>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>

    <!-- Modale avec navigation pour afficher les images de la galerie -->
    <div id="imageModal" class="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999;">
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative;">
            <!-- Fl√®che pr√©c√©dente -->
            <button id="prevImage" style="position: absolute; left: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 10000;">‚ùÆ</button>
            
            <!-- Image principale -->
            <img id="modalImage" src="" alt="" style="max-width: 85%; max-height: 85%; border-radius: 15px; object-fit: contain; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
            
            <!-- Fl√®che suivante -->
            <button id="nextImage" style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 10000;">‚ùØ</button>
            
            <!-- Bouton fermer -->
            <button type="button" class="btn-close" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
            
            <!-- Compteur d'images -->
            <div id="imageCounter" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500;"></div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- Scripts JavaScript pour les fonctionnalit√©s sp√©cifiques -->
    <script src="{{ asset('js/image-cleanup-universal.js') }}"></script>
    <script src="{{ asset('js/table-sort.js') }}"></script>
    <script src="{{ asset('js/table-read-only-protection.js') }}"></script>
    <script src="{{ asset('js/pages/post-detail.js') }}"></script>
    
    {% if jsonLdData is defined %}
        <!-- Donn√©es structur√©es JSON-LD pour le SEO -->
        <script type="application/ld+json">
            {{ jsonLdData|json_encode|raw }}
        </script>
    {% endif %}
{% endblock %}
