{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/rich-editor.css') }}" rel="stylesheet">
    <!-- Bootstrap Icons pour l'√©diteur riche -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <h2>"Qui suis-je ?" - Edition</h2>

    {{ form_start(form, { 'attr': { 'enctype': 'multipart/form-data' } }) }}

    <div class="blog-form-element-wrapper">
        {% for type, messages in app.flashes %}
            <div class="flash-messages {{ type }}">
                {% for message in messages %}
                    <div class="alert alert-{{ type }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
        <div class="m-2">{{ app.flashes('success') | join('<br>') | raw }}</div>
        <div class="row">
            <div class="col-sm-12 col-md-2">
                {{ form_label(form.content) }}
            </div>
            <div class="col-sm-12 col-md-8 form-editor">
                {{ form_widget(form.content, {'attr': {'style': 'display: none;', 'id': 'whoami_content'}}) }}
                <div id="richEditorContainer"></div>
                {{ form_errors(form.content) }}
            </div>
        </div>
        {% if app.user and app.user.getRole() == "admin" %}
            <button type="submit" class="btn btn-salmon">Valider</button>
        {% endif %}
    </div>
    {{ form_end(form) }}

    <!-- Modales pour l'√©diteur riche -->
    {% include 'components/_rich_editor_modals.html.twig' %}
    
    <!-- Scripts pour l'√©diteur riche -->
    <script src="{{ asset('js/RichEditor.js') }}"></script>
    <script src="{{ asset('js/form-handler.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ D√©marrage initialisation WhoAmI Rich Editor');
            
            // Attendre que tout soit charg√©
            setTimeout(function() {
                const editorContainer = document.getElementById('richEditorContainer');
                const hiddenField = document.getElementById('whoami_content');
                
                console.log('Container found:', !!editorContainer);
                console.log('Hidden field found:', !!hiddenField);
                console.log('RichEditor class available:', typeof RichEditor);
                
                if (editorContainer && hiddenField && typeof RichEditor !== 'undefined') {
                    try {
                        // Cr√©er l'√©diteur avec un ID personnalis√© pour le champ cach√©
                        window.richEditor = new RichEditor('richEditorContainer', {
                            hiddenFieldId: 'whoami_content',
                            placeholder: 'Pr√©sentez-vous ici...'
                        });
                        
                        console.log('‚úÖ √âditeur cr√©√© avec succ√®s');
                        
                        // Charger le contenu existant s'il y en a un
                        const existingContent = hiddenField.value;
                        if (existingContent && existingContent.trim() !== '') {
                            console.log('üìÑ Chargement contenu existant:', existingContent.length + ' caract√®res');
                            window.richEditor.setContent(existingContent);
                        }
                        
                        console.log('‚ú® WhoAmI Rich Editor initialis√© avec succ√®s!');
                        
                    } catch (error) {
                        console.error('‚ùå Erreur lors de l\'initialisation:', error);
                        
                        // Fallback - afficher le champ textarea normal
                        hiddenField.style.display = 'block';
                        hiddenField.style.height = '300px';
                        hiddenField.classList.add('form-control');
                        editorContainer.style.display = 'none';
                        
                        alert('L\''√©diteur riche n\'a pas pu se charger. Mode texte simple activ√©.');
                    }
                } else {
                    console.error('‚ùå √âl√©ments manquants pour l\'initialisation');
                    
                    // Mode d√©grad√©
                    if (hiddenField) {
                        hiddenField.style.display = 'block';
                        hiddenField.style.height = '300px';
                        hiddenField.classList.add('form-control');
                    }
                    if (editorContainer) {
                        editorContainer.innerHTML = '<p class="text-warning">L\''√©diteur riche n\'est pas disponible. Utilisez le champ texte ci-dessous.</p>';
                    }
                }
            }, 1000); // Attendre 1 seconde
        });
    </script>
{% endblock %}

