{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="{{ asset('css/form-styles.css') }}" rel="stylesheet">
    <link href="{{ asset('css/rich-editor.css') }}" rel="stylesheet">
    <link href="{{ asset('css/stable-images.css') }}" rel="stylesheet">
    <link href="{{ asset('css/image-fix-v3.css') }}" rel="stylesheet">
    <link href="{{ asset('css/post-content-styles.css') }}" rel="stylesheet">
    <link href="{{ asset('css/gallery-styles.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="form-container">
        <div class="form-header">
            <h2>Modifier l'article</h2>
            <p class="form-subtitle">Modifiez votre article et mettez √† jour votre contenu</p>
        </div>

        {# Messages flash #}
        {% for type, messages in app.flashes %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="alert alert-{{ type }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}

        {{ form_start(form, { 'attr': { 'enctype': 'multipart/form-data', 'id': 'postForm' } }) }}

        {# Titre #}
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-pen"></i>
                {{ form_label(form.title) }}
            </label>
            {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
            {{ form_errors(form.title) }}
        </div>

        {# Cat√©gorie #}
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-grid-3x3-gap"></i>
                {{ form_label(form.category) }}
            </label>
            {{ form_widget(form.category, {'attr': {'class': 'form-control'}}) }}
            {{ form_errors(form.category) }}
            <div class="category-tags mt-2">
                <span class="category-tag recipe" data-tooltip="Pour vos d√©licieuses recettes">üç≥ Recette</span>
                <span class="category-tag photo" data-tooltip="Pour vos plus belles photos">üì∏ Photo</span>
                <span class="category-tag event" data-tooltip="Pour vos √©v√©nements">üéâ √âv√©nement</span>
                <span class="category-tag blabla" data-tooltip="Pour discuter">üí¨ Blabla</span>
            </div>
        </div>

        {# Contenu avec l'√©diteur riche #}
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-file-text"></i>
                {{ form_label(form.content) }}
            </label>

            {# D'abord, rendre le widget du formulaire #}
            {{ form_widget(form.content, {'attr': {'style': 'display: none;', 'id': 'post_content'}}) }}
            <div id="richEditorContainer" class="editor-form-container"></div>

            {{ form_errors(form.content) }}
        </div>

        {# Champs conditionnels pour les √©v√©nements #}
        <div class="conditional-section date-wrapper" style="{{ post.category == 'event' ? 'display: block;' : 'display: none;' }}">
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-calendar-event"></i>
                    {{ form_label(form.date) }}
                </label>
                {{ form_widget(form.date, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.date) }}
            </div>
        </div>

        <div class="conditional-section place-wrapper" style="{{ post.category == 'event' ? 'display: block;' : 'display: none;' }}">
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-geo-alt"></i>
                    {{ form_label(form.place) }}
                </label>
                {{ form_widget(form.place, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.place) }}
            </div>
        </div>

        {# Champs conditionnels pour les recettes #}
        <div class="conditional-section personsNumber-wrapper" style="{{ post.category == 'recipe' ? 'display: block;' : 'display: none;' }}">
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-people"></i>
                    {{ form_label(form.personsNumber) }}
                </label>
                {{ form_widget(form.personsNumber, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.personsNumber) }}
            </div>
        </div>

        <div class="conditional-section cookingTime-wrapper" style="{{ post.category == 'recipe' ? 'display: block;' : 'display: none;' }}">
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-clock"></i>
                    {{ form_label(form.cookingTime) }}
                </label>
                {{ form_widget(form.cookingTime, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.cookingTime) }}
            </div>
        </div>

        {# Image √† la une #}
        <div class="form-group">
            <label class="form-label">
                <i class="bi bi-image"></i>
                {{ form_label(form.image) }}
            </label>

            {# Afficher l'image actuelle si elle existe #}
            {% if post.image %}
                <div class="current-image mb-3">
                    <p class="text-muted mb-2">Image actuelle :</p>
                    <img src="{{ asset(post.image) }}" alt="Image actuelle" class="img-thumbnail" style="max-width: 200px;">
                </div>
            {% endif %}

            <div class="image-upload-wrapper">
                {{ form_widget(form.image, {'attr': {'class': 'main-file-input'}}) }}
                <div class="main-upload-button">
                    <div>
                        <i class="bi bi-cloud-upload"></i>
                        <p class="upload-text">Cliquez ou glissez une nouvelle image ici</p>
                        <small class="text-muted">JPG, PNG ou GIF - Max 5MB</small>
                    </div>
                </div>
            </div>
            {{ form_errors(form.image) }}
        </div>

        {# Galerie d'images pour la cat√©gorie photo #}
        <div class="form-group gallery-images-wrapper" style="{{ post.category == 'photo' ? 'display: block;' : 'display: none;' }}">
            <label class="form-label">
                <i class="bi bi-images"></i>
                {{ form_label(form.galleryImages) }}
            </label>
            
            {# Affichage des images existantes de la galerie #}
            {% if post.postImages|length > 0 %}
                <div class="current-gallery mb-3">
                    <p class="text-muted mb-2">Images actuelles de la galerie ({{ post.postImages|length }}) :</p>
                    <div class="gallery-grid">
                        {% for postImage in post.postImages %}
                            <div class="gallery-item" data-image-id="{{ postImage.id }}">
                                <img src="{{ postImage.imageUrl }}" alt="{{ postImage.alt }}" class="gallery-thumbnail">
                                <div class="gallery-item-actions">
                                    <button type="button" class="btn btn-sm btn-danger delete-gallery-image" 
                                            data-image-id="{{ postImage.id }}" 
                                            data-post-id="{{ post.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <div class="gallery-upload-wrapper">
                {{ form_widget(form.galleryImages, {'attr': {'class': 'gallery-file-input', 'multiple': 'multiple', 'accept': 'image/*'}}) }}
                <div class="gallery-upload-button">
                    <div>
                        <i class="bi bi-card-image"></i>
                        <p class="upload-text">Cliquez ou glissez-d√©posez de nouvelles images</p>
                        <small class="text-muted">JPG, PNG, GIF ou WebP - Max 5MB chaque - Max 50 images</small>
                    </div>
                </div>
                <div class="gallery-preview" id="galleryPreview"></div>
            </div>
            {{ form_errors(form.galleryImages) }}
            <div class="form-help">
                {{ form_help(form.galleryImages) }}
            </div>
        </div>

        {# Actions #}
        <div class="form-actions">
            <a href="{{ path('post_detail', {'post': post.id}) }}" class="btn btn-salmon">
                <i class="bi bi-arrow-left-circle"></i>
                Retour √† l'article
            </a>
            <button type="submit" class="btn btn-orange">
                <i class="bi bi-check-circle"></i>
                Mettre √† jour l'article
            </button>
        </div>

        {{ form_end(form) }}
    </div>

    {# Modales pour l'√©diteur #}
    {% include 'components/_simple_editor_modals.html.twig' %}

    <script src="{{ asset('js/SimpleRichEditor-v3-fixed.js') }}"></script>
    <script src="{{ asset('js/form-handler.js') }}"></script>
    <script src="{{ asset('js/gallery-init.js') }}"></script>
    <script src="{{ asset('js/gallery-simple.js') }}"></script>


{% endblock %}