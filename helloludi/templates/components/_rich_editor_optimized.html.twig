{# templates/components/_rich_editor_optimized.html.twig #}

{# CSS de l'éditeur #}
<link rel="stylesheet" href="{{ asset('css/rich-editor.css') }}">

{# HTML de l'éditeur #}
<div id="richEditor"
     class="rich-editor-container editor-loading"
     data-upload-url="{{ path('upload_image') }}"
     data-hidden-field="{{ field_name|default('content') }}">

    <div class="editor-toolbar">
        <!-- Groupe formatage de base -->
        <div class="editor-group">
            <button type="button" class="editor-btn" data-command="bold" title="Gras (Ctrl+B)">
                <i class="bi bi-type-bold"></i>
            </button>
            <button type="button" class="editor-btn" data-command="italic" title="Italique (Ctrl+I)">
                <i class="bi bi-type-italic"></i>
            </button>
            <button type="button" class="editor-btn" data-command="underline" title="Souligné (Ctrl+U)">
                <i class="bi bi-type-underline"></i>
            </button>
            <button type="button" class="editor-btn" data-command="strikeThrough" title="Barré">
                <i class="bi bi-type-strikethrough"></i>
            </button>
        </div>

        <!-- Groupe couleurs -->
        <div class="editor-group">
            <div class="color-picker-wrapper">
                <input type="color" id="textColor" class="color-picker" value="#000000" title="Couleur du texte">
            </div>
            <div class="color-picker-wrapper">
                <input type="color" id="bgColor" class="color-picker" value="#ffffff" title="Couleur de fond">
            </div>
        </div>

        <!-- Groupe alignement -->
        <div class="editor-group">
            <button type="button" class="editor-btn" data-command="justifyLeft" title="Aligner à gauche">
                <i class="bi bi-text-left"></i>
            </button>
            <button type="button" class="editor-btn" data-command="justifyCenter" title="Centrer">
                <i class="bi bi-text-center"></i>
            </button>
            <button type="button" class="editor-btn" data-command="justifyRight" title="Aligner à droite">
                <i class="bi bi-text-right"></i>
            </button>
            <button type="button" class="editor-btn" data-command="justifyFull" title="Justifier">
                <i class="bi bi-justify"></i>
            </button>
        </div>

        <!-- Groupe listes -->
        <div class="editor-group">
            <button type="button" class="editor-btn" data-command="insertUnorderedList" title="Liste à puces">
                <i class="bi bi-list-ul"></i>
            </button>
            <button type="button" class="editor-btn" data-command="insertOrderedList" title="Liste numérotée">
                <i class="bi bi-list-ol"></i>
            </button>
            <button type="button" class="editor-btn" data-command="indent" title="Augmenter l'indentation">
                <i class="bi bi-indent-increase"></i>
            </button>
            <button type="button" class="editor-btn" data-command="outdent" title="Diminuer l'indentation">
                <i class="bi bi-indent-decrease"></i>
            </button>
        </div>

        <!-- Groupe insertion -->
        <div class="editor-group">
            <button type="button" class="editor-btn" id="linkBtn" title="Insérer un lien">
                <i class="bi bi-link-45deg"></i>
            </button>
            <button type="button" class="editor-btn" id="imageBtn" title="Insérer une image">
                <i class="bi bi-image"></i>
            </button>
            <button type="button" class="editor-btn" id="tableBtn" title="Insérer un tableau">
                <i class="bi bi-table"></i>
            </button>
            <button type="button" class="editor-btn" id="videoBtn" title="Insérer une vidéo YouTube">
                <i class="bi bi-youtube"></i>
            </button>
        </div>

        <!-- Groupe format spécial -->
        <div class="editor-group">
            <button type="button" class="editor-btn" id="quoteBtn" title="Citation">
                <i class="bi bi-quote"></i>
            </button>
            <button type="button" class="editor-btn" id="codeBtn" title="Code">
                <i class="bi bi-code-square"></i>
            </button>
            <button type="button" class="editor-btn" data-command="insertHorizontalRule" title="Ligne horizontale">
                <i class="bi bi-hr"></i>
            </button>
        </div>

        <!-- Groupe utilitaires -->
        <div class="editor-group">
            <button type="button" class="editor-btn" id="fullscreenBtn" title="Plein écran">
                <i class="bi bi-fullscreen"></i>
            </button>
        </div>
    </div>

    <div class="editor-content"
         contenteditable="true"
         data-placeholder="Commencez à taper votre contenu ici...">
        {% if content is defined and content %}
            {{ content|raw }}
        {% endif %}
    </div>
</div>

{# Champ caché pour le formulaire #}
<input type="hidden"
       id="{{ field_name|default('content') }}"
       name="{{ field_name|default('content') }}"
       value="{{ content|default('')|e('html_attr') }}">

{# Inclure les modales #}
{% include 'components/_editor_modals_optimized.html.twig' %}

{# Scripts JavaScript optimisés #}
<script src="{{ asset('js/RichEditor.js') }}"></script>
<script src="{{ asset('js/ModalManager.js') }}"></script>
<script src="{{ asset('js/EditorManager.js') }}"></script>
<script src="{{ asset('js/editor-init.js') }}"></script>

{# CSS pour l'état de chargement #}
<style>
    .rich-editor-container.editor-loading {
        opacity: 0.5;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .rich-editor-container.editor-ready {
        opacity: 1;
        pointer-events: auto;
    }
</style>

{# Script d'initialisation UNIQUE #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Attendre que l'éditeur soit prêt
        document.addEventListener('editorManagerready', function(event) {
            const container = document.getElementById('richEditor');
            if (container) {
                container.classList.remove('editor-loading');
                container.classList.add('editor-ready');
                console.log('Rich Editor is ready and visible');
            }
        });

        // Forcer la fermeture des modales après insertion
        document.addEventListener('click', function(e) {
            if (e.target.id && e.target.id.includes('insert') && e.target.id.includes('Btn')) {
                setTimeout(() => {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                        modal.style.display = 'none';
                        modal.setAttribute('aria-hidden', 'true');
                    });
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 500);
            }
        });
    });
</script>

<script>
    // Test simple pour vérifier la sélection des vidéos
    document.addEventListener('richEditorready', function() {
        setTimeout(() => {
            document.addEventListener('click', function(e) {
                if (e.target.closest('.video-main-wrapper')) {
                    console.log('Video clicked!');
                    const wrapper = e.target.closest('.video-main-wrapper');
                    wrapper.style.border = '2px solid red'; // Test visuel
                }
            });
        }, 1000);
    });
</script>