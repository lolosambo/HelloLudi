/* 
 * CORRECTION SYSTÈME D'IMAGES V3 - Fix définitif
 * Résout tous les problèmes d'alignement et de sélection
 */

/* === RESET ET STABILISATION === */
.rich-editor-container {
    position: relative !important;
    width: 100% !important;
    max-width: 100% !important;
    /* Empêcher tout débordement */
    overflow: visible !important;
    box-sizing: border-box !important;
}

.editor-content {
    position: relative !important;
    width: 100% !important;
    box-sizing: border-box !important;
    /* Permettre le float des images */
    overflow: visible !important;
}

/* === IMAGES DANS L'ÉDITEUR - VERSION CORRIGÉE === */
.editor-content img {
    /* Styles de base */
    max-width: 100% !important;
    height: auto !important;
    border-radius: 4px;
    cursor: pointer;
    transition: none !important; /* Empêcher les animations qui cassent */
    display: inline-block; /* Par défaut */
    margin: 10px 5px; /* Marge par défaut */
    vertical-align: top; /* Alignement vertical stable */
    
    /* Forcer la position stable */
    position: static !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    
    /* Empêcher le drag */
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
    
    /* Propriétés de base pour tous les alignements */
    box-sizing: border-box;
}

/* === ALIGNEMENTS CORRECTS === */

/* Alignement gauche - Le texte s'enroule à droite */
.editor-content img.align-left {
    float: left !important;
    clear: left !important;
    margin: 0 15px 15px 0 !important; /* Marge à droite et en bas */
    max-width: 50% !important; /* Limite pour laisser place au texte */
    display: block !important;
}

/* Alignement droite - Le texte s'enroule à gauche */
.editor-content img.align-right {
    float: right !important;
    clear: right !important;
    margin: 0 0 15px 15px !important; /* Marge à gauche et en bas */
    max-width: 50% !important; /* Limite pour laisser place au texte */
    display: block !important;
}

/* Alignement centre - Aucun enroulement */
.editor-content img.align-center {
    display: block !important;
    float: none !important;
    clear: both !important;
    margin: 15px auto !important; /* Centre horizontalement */
    text-align: center !important;
}

/* === SYSTÈME DE SÉLECTION CORRIGÉ === */

/* Container pour image sélectionnée */
.editor-content .image-selection-wrapper {
    position: relative !important;
    display: inline-block !important;
    line-height: 0 !important; /* Empêche les espaces parasites */
    vertical-align: top !important;
    
    /* Hérite de l'alignement de l'image */
    float: inherit !important;
    clear: inherit !important;
    margin: inherit !important;
    max-width: inherit !important;
}

/* Quand l'image est alignée à gauche */
.editor-content img.align-left + .image-selection-wrapper,
.editor-content .image-selection-wrapper.align-left {
    float: left !important;
    clear: left !important;
    margin: 0 15px 15px 0 !important;
    max-width: 50% !important;
    display: block !important;
}

/* Quand l'image est alignée à droite */
.editor-content img.align-right + .image-selection-wrapper,
.editor-content .image-selection-wrapper.align-right {
    float: right !important;
    clear: right !important;
    margin: 0 0 15px 15px !important;
    max-width: 50% !important;
    display: block !important;
}

/* Quand l'image est centrée */
.editor-content img.align-center + .image-selection-wrapper,
.editor-content .image-selection-wrapper.align-center {
    display: block !important;
    float: none !important;
    clear: both !important;
    margin: 15px auto !important;
    text-align: center !important;
}

/* Image à l'intérieur du wrapper de sélection */
.editor-content .image-selection-wrapper img {
    /* L'image remplit exactement son wrapper */
    width: 100% !important;
    max-width: 100% !important;
    display: block !important;
    margin: 0 !important;
    float: none !important;
    clear: none !important;
    
    /* Position absolument stable */
    position: static !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
}

/* === BORDURE DE SÉLECTION === */
.editor-content .image-selection-border {
    position: absolute !important;
    top: -3px !important;
    left: -3px !important;
    right: -3px !important;
    bottom: -3px !important;
    border: 3px solid #007bff !important;
    border-radius: 8px !important;
    pointer-events: none !important;
    z-index: 10 !important;
    box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.25) !important;
    background: none !important;
}

/* === POIGNÉE DE REDIMENSIONNEMENT AMÉLIORÉE === */
.editor-content .image-resize-handle {
    position: absolute !important;
    bottom: -12px !important;
    right: -12px !important;
    width: 24px !important;
    height: 24px !important;
    background: #007bff !important;
    border: 3px solid white !important;
    border-radius: 50% !important;
    cursor: se-resize !important;
    z-index: 1000 !important;
    font-size: 16px !important;
    color: white !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: bold !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    user-select: none !important;
    line-height: 1 !important;
    /* Assurer la visibilité */
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: all !important;
    /* Amélioration tactile */
    touch-action: none !important;
}

.editor-content .image-resize-handle:hover {
    background: #0056b3 !important;
    transform: scale(1.15) !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4) !important;
    transition: all 0.2s ease !important;
}

.editor-content .image-resize-handle:active {
    background: #0056b3 !important;
    transform: scale(1.25) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5) !important;
}

.editor-content .image-resize-handle::before {
    content: "↘" !important;
    font-size: 16px !important;
    line-height: 1 !important;
    font-family: system-ui, -apple-system, sans-serif !important;
}

/* === CURSEUR ET FEEDBACK PENDANT LE REDIMENSIONNEMENT === */
body.resizing-image,
body.resizing-image * {
    cursor: se-resize !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
}

/* Amélioration visuelle pendant redimensionnement */
.image-selection-wrapper.resizing {
    outline: 2px solid #007bff !important;
    outline-offset: 2px !important;
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.3) !important;
}

.image-selection-wrapper.resizing img {
    opacity: 0.8 !important;
    transition: none !important; /* Pas d'animation pendant resize */
}

.image-selection-wrapper.resizing .image-resize-handle {
    background: #0056b3 !important;
    transform: scale(1.3) !important;
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.5) !important;
}

/* === AMÉLIORATION TACTILE MOBILE === */
@media (hover: none) and (pointer: coarse) {
    .editor-content .image-resize-handle {
        width: 32px !important;
        height: 32px !important;
        bottom: -16px !important;
        right: -16px !important;
        font-size: 20px !important;
    }
}

/* === MODES DE REDIMENSIONNEMENT === */
body.image-resizing {
    cursor: se-resize !important;
    user-select: none !important;
    -webkit-user-select: none !important;
}

body.image-resizing * {
    user-select: none !important;
    -webkit-user-select: none !important;
}

/* === CLEARFIX === */
.editor-content::after {
    content: "" !important;
    display: table !important;
    clear: both !important;
}

/* === COMPATIBILITÉ AVEC LES ANCIENNES CLASSES === */

/* Classes de l'ancien système toujours supportées */
.editor-content img.wrap-left {
    float: left !important;
    clear: left !important;
    margin: 0 15px 15px 0 !important;
    max-width: 45% !important;
    display: block !important;
}

.editor-content img.wrap-right {
    float: right !important;
    clear: right !important;
    margin: 0 0 15px 15px !important;
    max-width: 45% !important;
    display: block !important;
}

/* Images interactives - Indication visuelle */
.editor-content img[data-interactive="true"] {
    cursor: pointer !important;
    transition: opacity 0.2s ease, box-shadow 0.2s ease !important;
}

.editor-content img[data-interactive="true"]:hover {
    opacity: 0.9 !important;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2) !important;
}

/* === HOVER EFFECTS === */
.editor-content img:hover {
    opacity: 0.9 !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
}

.editor-content .image-selection-wrapper:hover img {
    opacity: 1 !important;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    /* Sur mobile, simplifier les alignements */
    .editor-content img.align-left,
    .editor-content img.align-right,
    .editor-content img.wrap-left,
    .editor-content img.wrap-right {
        float: none !important;
        display: block !important;
        margin: 15px auto !important;
        max-width: 100% !important;
        clear: both !important;
    }
    
    .editor-content .image-selection-wrapper.align-left,
    .editor-content .image-selection-wrapper.align-right {
        float: none !important;
        display: block !important;
        margin: 15px auto !important;
        max-width: 100% !important;
        clear: both !important;
        text-align: center !important;
    }
}

/* === PRÉVENTION DES BUGS === */

/* Empêcher les conteneurs de changer l'alignement des images */
.editor-content div:not(.image-selection-wrapper) img {
    /* Les images dans des div gardent leur alignement */
    float: inherit !important;
    clear: inherit !important;
    margin: inherit !important;
}

/* CORRECTION: Permettre les images plus grandes après redimensionnement personnalisé */
.editor-content img[data-custom-width] {
    /* L'image avec taille personnalisée peut dépasser les limites normales */
    max-width: none !important;
}

.editor-content img[data-custom-width].align-left,
.editor-content img[data-custom-width].align-right {
    /* Même alignée, si redimensionnée manuellement, respecter la taille */
    max-width: none !important;
}

/* Transition fluide pour les changements de taille hors redimensionnement */
.editor-content img:not(.resizing) {
    transition: width 0.2s ease, height 0.2s ease !important;
}

/* Empêcher les transformations qui cassent l'alignement */
.editor-content img,
.editor-content .image-selection-wrapper {
    transform: none !important;
    will-change: auto !important;
}

/* === DEBUG (à supprimer en production) === */
.debug-images .editor-content img {
    outline: 2px dashed red !important;
    outline-offset: 5px !important;
}

.debug-images .editor-content .image-selection-wrapper {
    outline: 2px dashed blue !important;
    outline-offset: 8px !important;
}

.debug-images .editor-content img.align-left::before {
    content: "GAUCHE" !important;
    position: absolute !important;
    top: -25px !important;
    left: 0 !important;
    background: red !important;
    color: white !important;
    padding: 2px 6px !important;
    font-size: 10px !important;
    z-index: 100 !important;
}

.debug-images .editor-content img.align-right::before {
    content: "DROITE" !important;
    position: absolute !important;
    top: -25px !important;
    right: 0 !important;
    background: blue !important;
    color: white !important;
    padding: 2px 6px !important;
    font-size: 10px !important;
    z-index: 100 !important;
}

.debug-images .editor-content img.align-center::before {
    content: "CENTRE" !important;
    position: absolute !important;
    top: -25px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    background: green !important;
    color: white !important;
    padding: 2px 6px !important;
    font-size: 10px !important;
    z-index: 100 !important;
}
