/**
 * Image Cleanup - Script universel pour toutes les pages
 * √Ä inclure sur TOUTES les pages (d√©tail + √©dition)
 * Nettoie automatiquement les images sur les pages sans richEditor
 */
(function() {
    'use strict';
    
    console.log('üîç === IMAGE CLEANUP UNIVERSEL ===');
    
    function universalImageCleanup() {
        console.log('üßπ Nettoyage universel des images...');
        
        // ‚úÖ R√àGLE ABSOLUE : Pas de richEditor = Nettoyage imm√©diat
        const hasRichEditorContainer = !!document.getElementById('richEditorContainer');
        const hasRichEditorScript = !!window.SimpleRichEditor || !!window.richEditor;
        
        console.log('üéØ V√âRIFICATION:');
        console.log(`   richEditorContainer: ${hasRichEditorContainer ? '‚úÖ PR√âSENT' : '‚ùå ABSENT'}`);
        console.log(`   richEditor script: ${hasRichEditorScript ? '‚úÖ PR√âSENT' : '‚ùå ABSENT'}`);
        
        // Si aucun richEditor d√©tect√©, nettoyer imm√©diatement
        if (!hasRichEditorContainer && !hasRichEditorScript) {
            console.log('üéØ AUCUN richEditor ‚Üí NETTOYAGE IMM√âDIAT');
            performCleanup();
            return true;
        }
        
        // Si richEditor pr√©sent mais on est sur une page de d√©tail (URL detection)
        const isLikelyDetailPage = detectDetailPage();
        if (isLikelyDetailPage && hasRichEditorScript) {
            console.log('üéØ Page d√©tail avec richEditor fant√¥me ‚Üí NETTOYAGE');
            performCleanup();
            return true;
        }
        
        console.log('‚úèÔ∏è Page d\'√©dition d√©tect√©e - Pas de nettoyage');
        return false;
    }
    
    function detectDetailPage() {
        const url = window.location.href;
        const path = window.location.pathname;
        
        // Indicateurs de page de d√©tail
        const detailIndicators = [
            /\/show\/\d+/i.test(path),           // /show/123
            /\/article\/\d+/i.test(path),        // /article/123
            /\/post\/\d+/i.test(path),           // /post/123
            /\/detail\/\d+/i.test(path),         // /detail/123
            /\/\d+\/?$/i.test(path),             // /123 ou /123/
            !!document.querySelector('.article-content, .post-content, .blog-post'),
            !!document.querySelector('.comments, .comment-section'),
            !document.querySelector('form[method="POST"]'),
            !document.querySelector('button[type="submit"]'),
            !/edit|admin|create/i.test(path)
        ];
        
        const score = detailIndicators.filter(Boolean).length;
        console.log(`üìä Score page d√©tail: ${score}/10`);
        
        return score >= 4;
    }
    
    function performCleanup() {
        console.log('üßπ === NETTOYAGE EN COURS ===');
        
        let cleanupCount = 0;
        
        // 1. Supprimer tous les wrappers de s√©lection
        const wrappers = document.querySelectorAll('.image-selection-wrapper, .forced-wrapper');
        console.log(`   üóëÔ∏è Suppression de ${wrappers.length} wrapper(s)`);
        
        wrappers.forEach((wrapper, index) => {
            const img = wrapper.querySelector('img');
            if (img) {
                // Restaurer alignement
                const alignment = wrapper.dataset.alignment;
                if (alignment && alignment !== 'default') {
                    img.classList.add(`align-${alignment}`);
                }
                wrapper.parentNode.insertBefore(img, wrapper);
                cleanupCount++;
            }
            wrapper.remove();
        });
        
        // 2. Supprimer toutes les poign√©es
        const handles = document.querySelectorAll('.image-resize-handle, .forced-handle');
        console.log(`   üóëÔ∏è Suppression de ${handles.length} poign√©e(s)`);
        handles.forEach(handle => {
            handle.remove();
            cleanupCount++;
        });
        
        // 3. Supprimer bordures de s√©lection
        const borders = document.querySelectorAll('.image-selection-border');
        console.log(`   üóëÔ∏è Suppression de ${borders.length} bordure(s)`);
        borders.forEach(border => {
            border.remove();
            cleanupCount++;
        });
        
        // 4. Nettoyer TOUTES les images
        const images = document.querySelectorAll('img');
        console.log(`   üì∑ Configuration de ${images.length} image(s) en lecture seule`);
        
        images.forEach((img, index) => {
            // Cloner pour supprimer tous √©v√©nements
            const cleanImg = img.cloneNode(true);
            if (img.parentNode) {
                img.parentNode.replaceChild(cleanImg, img);
            }
            
            // Styles lecture seule FORC√âS
            cleanImg.style.cssText += `
                cursor: default !important;
                pointer-events: none !important;
            `;
            cleanImg.title = '';
            
            // Nettoyer attributs
            cleanImg.removeAttribute('data-processed');
            cleanImg.removeAttribute('data-interactive');
            cleanImg.removeAttribute('onclick');
            cleanImg.removeAttribute('ondblclick');
            
            // Anti-drag
            cleanImg.addEventListener('dragstart', (e) => e.preventDefault());
            
            // Marquer comme nettoy√©e
            cleanImg.dataset.cleanedUp = 'true';
            cleanupCount++;
        });
        
        console.log(`‚úÖ NETTOYAGE TERMIN√â - ${cleanupCount} √©l√©ment(s) trait√©(s)`);
        
        // V√©rification apr√®s 500ms
        setTimeout(() => {
            verifyCleanup();
        }, 500);
    }
    
    function verifyCleanup() {
        console.log('üîç === V√âRIFICATION POST-NETTOYAGE ===');
        
        const remainingWrappers = document.querySelectorAll('.image-selection-wrapper');
        const remainingHandles = document.querySelectorAll('.image-resize-handle');
        const interactiveImages = document.querySelectorAll('img:not([data-cleaned-up="true"])');
        const cleanedImages = document.querySelectorAll('img[data-cleaned-up="true"]');
        
        console.log(`üìä R√âSULTATS:`);
        console.log(`   Wrappers restants: ${remainingWrappers.length} (devrait √™tre 0)`);
        console.log(`   Poign√©es restantes: ${remainingHandles.length} (devrait √™tre 0)`);
        console.log(`   Images interactives: ${interactiveImages.length} (devrait √™tre 0)`);
        console.log(`   Images nettoy√©es: ${cleanedImages.length}`);
        
        if (remainingWrappers.length === 0 && remainingHandles.length === 0) {
            console.log('üéâ SUCCESS: Page parfaitement nettoy√©e');
        } else {
            console.log('‚ö†Ô∏è Nettoyage suppl√©mentaire n√©cessaire...');
            
            // Nettoyage forc√© des √©l√©ments restants
            remainingWrappers.forEach(w => {
                console.log('   üîß Force suppression wrapper restant');
                w.remove();
            });
            
            remainingHandles.forEach(h => {
                console.log('   üîß Force suppression poign√©e restante');
                h.remove();
            });
            
            // Forcer les images restantes
            interactiveImages.forEach(img => {
                console.log('   üîß Force nettoyage image restante');
                img.style.cursor = 'default';
                img.style.pointerEvents = 'none';
                img.dataset.cleanedUp = 'true';
            });
            
            console.log('‚úÖ Nettoyage forc√© termin√©');
        }
    }
    
    // Surveillance continue pour les √©l√©ments ajout√©s dynamiquement
    function setupContinuousMonitoring() {
        console.log('üëÅÔ∏è Mise en place surveillance continue...');
        
        const observer = new MutationObserver((mutations) => {
            let needsCleanup = false;
            
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // V√©rifier si des √©l√©ments suspects sont ajout√©s
                            if (node.classList?.contains('image-selection-wrapper') ||
                                node.classList?.contains('image-resize-handle') ||
                                node.tagName === 'IMG' ||
                                node.querySelector?.('img, .image-selection-wrapper, .image-resize-handle')) {
                                needsCleanup = true;
                            }
                        }
                    });
                }
            });
            
            if (needsCleanup) {
                console.log('üö® √âl√©ments suspects d√©tect√©s - Nettoyage automatique');
                setTimeout(performCleanup, 100);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('‚úÖ Surveillance continue active');
    }
    
    // === EX√âCUTION AUTOMATIQUE ===
    
    function init() {
        // Attendre que le DOM soit pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
            return;
        }
        
        console.log('üöÄ Initialisation Image Cleanup Universel');
        
        // D√©lai pour laisser le temps aux autres scripts de se charger
        setTimeout(() => {
            const wasCleanedUp = universalImageCleanup();
            
            if (wasCleanedUp) {
                console.log('üõ°Ô∏è Mode surveillance activ√©');
                setupContinuousMonitoring();
            } else {
                console.log('‚úèÔ∏è Page d\'√©dition - Pas de surveillance');
            }
        }, 200);
    }
    
    // Lancer imm√©diatement si DOM d√©j√† pr√™t, sinon attendre
    init();
    
    // Export pour tests manuels
    window.imageCleanup = {
        performCleanup: performCleanup,
        verifyCleanup: verifyCleanup,
        universalImageCleanup: universalImageCleanup
    };
    
    console.log('üí° Test manuel disponible: window.imageCleanup.performCleanup()');
    
})();
