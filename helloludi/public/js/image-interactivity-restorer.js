/**
 * Script pour restaurer l'interactivit√© des images apr√®s validation
 * √Ä inclure dans les templates d'√©dition et d'affichage
 */
(function() {
    'use strict';

    // Attendre que le DOM soit charg√©
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Initialisation de la restauration d\'interactivit√© des images');
        
        // D√©lai pour s'assurer que tout est bien charg√©
        setTimeout(() => {
            restoreImageInteractivity();
        }, 500);
    });

    /**
     * Restaure l'interactivit√© de toutes les images dans le contenu
     */
    function restoreImageInteractivity() {
        // Chercher dans les conteneurs de contenu d'articles
        const contentContainers = document.querySelectorAll(
            '.post-content, .editor-content, .article-content, #richEditorContainer .editor-content'
        );

        let totalImagesFound = 0;
        let totalImagesRestored = 0;

        contentContainers.forEach(container => {
            if (!container) return;

            // Trouver toutes les images dans le conteneur
            const images = container.querySelectorAll('img');
            totalImagesFound += images.length;

            images.forEach(img => {
                if (restoreImageInteractivity_Single(img, container)) {
                    totalImagesRestored++;
                }
            });
        });

        if (totalImagesFound > 0) {
            console.log(`‚úÖ ${totalImagesRestored}/${totalImagesFound} images restaur√©es avec interactivit√©`);
        } else {
            console.log('‚ÑπÔ∏è Aucune image trouv√©e √† restaurer');
        }
    }

    /**
     * Restaure l'interactivit√© d'une image sp√©cifique
     * @param {HTMLImageElement} img 
     * @param {HTMLElement} container 
     * @returns {boolean} Succ√®s de la restauration
     */
    function restoreImageInteractivity_Single(img, container) {
        // V√©rifier si l'image est d√©j√† interactive
        if (img.classList.contains('interactive-image') || img.classList.contains('editor-image')) {
            return false; // D√©j√† interactive
        }

        // Ajouter les classes n√©cessaires
        img.classList.add('editor-image', 'interactive-image', 'resizable');

        // Ajouter les styles de base si manquants
        if (!img.style.cursor) {
            img.style.cursor = 'pointer';
        }

        // Forcer la persistance des styles d'alignement existants
        forceImageAlignmentStyles(img);

        // Ajouter les √©v√©nements d'interactivit√©
        setupImageEvents(img, container);

        return true;
    }

    /**
     * Force les styles d'alignement bas√©s sur les classes existantes
     * @param {HTMLImageElement} img 
     */
    function forceImageAlignmentStyles(img) {
        // D√©tecter l'alignement bas√© sur les classes CSS existantes
        if (img.classList.contains('align-left') || img.classList.contains('wrap-left')) {
            img.style.cssText += `
                float: left !important;
                margin: 5px 15px 15px 5px !important;
                clear: left !important;
                max-width: 50% !important;
                height: auto !important;
                display: block !important;
                position: static !important;
            `;
            console.log('üìç Image alignement GAUCHE restaur√©');
        } else if (img.classList.contains('align-right') || img.classList.contains('wrap-right')) {
            img.style.cssText += `
                float: right !important;
                margin: 5px 5px 15px 15px !important;
                clear: right !important;
                max-width: 50% !important;
                height: auto !important;
                display: block !important;
                position: static !important;
            `;
            console.log('üìç Image alignement DROITE restaur√©');
        } else if (img.classList.contains('align-center')) {
            img.style.cssText += `
                display: block !important;
                margin: 15px auto !important;
                float: none !important;
                max-width: 100% !important;
                height: auto !important;
                position: static !important;
            `;
            console.log('üìç Image alignement CENTRE restaur√©');
        } else {
            // Si aucune classe d'alignement, d√©tecter par les styles inline existants
            const computedStyle = window.getComputedStyle(img);
            if (computedStyle.float === 'left') {
                img.classList.add('align-left');
                console.log('üîç Alignement GAUCHE d√©tect√© et classe ajout√©e');
            } else if (computedStyle.float === 'right') {
                img.classList.add('align-right');
                console.log('üîç Alignement DROITE d√©tect√© et classe ajout√©e');
            }
        }
    }

    /**
     * Configure les √©v√©nements d'interactivit√© pour une image
     * @param {HTMLImageElement} img 
     * @param {HTMLElement} container 
     */
    function setupImageEvents(img, container) {
        // Marquer comme configur√© pour √©viter les doublons
        if (img.dataset.eventsSetup === 'true') {
            return;
        }
        img.dataset.eventsSetup = 'true';

        // Clic simple pour s√©lectionner
        img.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            selectImage(img, container);
        });

        // Double-clic pour √©diter (si l'√©diteur est disponible)
        img.addEventListener('dblclick', function(e) {
            e.preventDefault();
            e.stopPropagation();
            editImage(img);
        });

        // Survol pour indiquer l'interactivit√©
        img.addEventListener('mouseenter', function() {
            if (!this.classList.contains('selected')) {
                this.style.opacity = '0.8';
                this.style.transition = 'opacity 0.2s ease';
            }
        });

        img.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.opacity = '1';
            }
        });

        console.log('üéØ √âv√©nements d\'interactivit√© ajout√©s √† l\'image');
    }

    /**
     * S√©lectionne une image et ajoute la poign√©e de redimensionnement
     * @param {HTMLImageElement} img 
     * @param {HTMLElement} container 
     */
    function selectImage(img, container) {
        // D√©s√©lectionner les autres images
        container.querySelectorAll('img.selected').forEach(otherImg => {
            otherImg.classList.remove('selected');
            otherImg.style.opacity = '1';
            removeResizeHandle(otherImg);
        });

        // S√©lectionner cette image
        img.classList.add('selected');
        img.style.opacity = '1';
        img.style.outline = '3px solid #007bff';
        img.style.outlineOffset = '2px';

        // Ajouter la poign√©e de redimensionnement
        addResizeHandle(img);

        console.log('‚úÖ Image s√©lectionn√©e avec poign√©e ajout√©e');
    }

    /**
     * Ouvre la modale d'√©dition d'image (si disponible)
     * @param {HTMLImageElement} img 
     */
    function editImage(img) {
        // V√©rifier si l'√©diteur riche est disponible
        if (window.richEditor && typeof window.richEditor.editImage === 'function') {
            console.log('üé® Ouverture de l\'√©diteur d\'image via RichEditor');
            window.richEditor.editImage(img);
            return;
        }

        // Sinon, ouvrir une modale basique ou afficher les informations
        console.log('‚ö†Ô∏è √âditeur riche non disponible - affichage des informations image');
        showImageInfo(img);
    }

    /**
     * Affiche les informations d'une image dans une alerte
     * @param {HTMLImageElement} img 
     */
    function showImageInfo(img) {
        const info = [
            `URL: ${img.src}`,
            `Alt: ${img.alt || 'Non d√©fini'}`,
            `Largeur: ${img.offsetWidth}px`,
            `Hauteur: ${img.offsetHeight}px`,
            `Classes: ${img.className}`,
            `Alignement d√©tect√©: ${detectAlignment(img)}`
        ].join('\n');

        alert(`Informations de l'image:\n\n${info}\n\nPour √©diter cette image, utilisez la page d'√©dition de l'article.`);
    }

    /**
     * D√©tecte l'alignement d'une image
     * @param {HTMLImageElement} img 
     * @returns {string}
     */
    function detectAlignment(img) {
        if (img.classList.contains('align-left') || img.classList.contains('wrap-left')) {
            return 'Gauche';
        } else if (img.classList.contains('align-right') || img.classList.contains('wrap-right')) {
            return 'Droite';
        } else if (img.classList.contains('align-center')) {
            return 'Centre';
        } else {
            const computedStyle = window.getComputedStyle(img);
            if (computedStyle.float === 'left') return 'Gauche (d√©tect√©)';
            if (computedStyle.float === 'right') return 'Droite (d√©tect√©)';
            return 'Par d√©faut';
        }
    }

    /**
     * Ajoute une poign√©e de redimensionnement √† une image
     * @param {HTMLImageElement} img 
     */
    function addResizeHandle(img) {
        // Supprimer une √©ventuelle poign√©e existante
        removeResizeHandle(img);

        // Cr√©er le wrapper s'il n'existe pas
        let wrapper = img.parentElement;
        if (!wrapper.classList.contains('image-wrapper')) {
            wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            wrapper.style.cssText = `
                position: relative;
                display: inline-block;
                line-height: 0;
            `;
            
            // Ins√©rer le wrapper √† la position de l'image
            img.parentNode.insertBefore(wrapper, img);
            wrapper.appendChild(img);
        }

        // Cr√©er la poign√©e
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        handle.innerHTML = '‚áò';
        handle.style.cssText = `
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            cursor: se-resize;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            user-select: none;
            transition: all 0.2s ease;
        `;

        handle.addEventListener('mouseenter', function() {
            this.style.background = '#0056b3';
            this.style.transform = 'scale(1.1)';
        });

        handle.addEventListener('mouseleave', function() {
            this.style.background = '#007bff';
            this.style.transform = 'scale(1)';
        });

        // Ajouter les √©v√©nements de redimensionnement
        setupResizeEvents(handle, img);

        wrapper.appendChild(handle);
    }

    /**
     * Supprime la poign√©e de redimensionnement d'une image
     * @param {HTMLImageElement} img 
     */
    function removeResizeHandle(img) {
        const wrapper = img.parentElement;
        if (wrapper && wrapper.classList.contains('image-wrapper')) {
            const handle = wrapper.querySelector('.resize-handle');
            if (handle) {
                handle.remove();
            }
            
            // Si plus de poign√©e, supprimer le wrapper
            if (!wrapper.querySelector('.resize-handle')) {
                const parent = wrapper.parentNode;
                parent.insertBefore(img, wrapper);
                wrapper.remove();
            }
        }

        // Supprimer le style de s√©lection
        img.style.outline = '';
        img.style.outlineOffset = '';
    }

    /**
     * Configure les √©v√©nements de redimensionnement
     * @param {HTMLElement} handle 
     * @param {HTMLImageElement} img 
     */
    function setupResizeEvents(handle, img) {
        let isResizing = false;
        let startX, startWidth, startHeight, aspectRatio;

        handle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            startX = e.clientX;
            startWidth = img.offsetWidth;
            startHeight = img.offsetHeight;
            aspectRatio = startHeight / startWidth;
            
            document.body.style.cursor = 'se-resize';
            document.body.style.userSelect = 'none';

            console.log('üéØ D√©but redimensionnement');
        });

        const handleMouseMove = (e) => {
            if (!isResizing) return;
            
            e.preventDefault();
            
            const deltaX = e.clientX - startX;
            const newWidth = Math.max(50, Math.min(startWidth + deltaX, 800));
            const newHeight = newWidth * aspectRatio;
            
            img.style.width = newWidth + 'px';
            img.style.height = newHeight + 'px';
        };

        const handleMouseUp = () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // Forcer la persistence des styles d'alignement
                forceImageAlignmentStyles(img);
                
                console.log(`‚úÖ Redimensionnement termin√©: ${img.style.width}`);
            }
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }

    // Gestion des clics ailleurs pour d√©s√©lectionner
    document.addEventListener('click', function(e) {
        if (!e.target.closest('img.editor-image') && !e.target.closest('.resize-handle')) {
            // D√©s√©lectionner toutes les images
            document.querySelectorAll('img.selected').forEach(img => {
                img.classList.remove('selected');
                img.style.outline = '';
                img.style.outlineOffset = '';
                img.style.opacity = '1';
                removeResizeHandle(img);
            });
        }
    });

    // Exposer les fonctions pour usage externe
    window.ImageInteractivityRestorer = {
        restore: restoreImageInteractivity,
        restoreSingle: restoreImageInteractivity_Single,
        selectImage: selectImage
    };

    console.log('üîß Script de restauration d\'interactivit√© des images charg√©');
})();